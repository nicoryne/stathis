name: Deploy to Staging

on:
  push:
    branches: [dev]
  pull_request:
    branches: [dev]
  workflow_dispatch:

jobs:
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    # Only deploy on push to dev, not on PRs
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/checkout@v4

      - name: Upload Code to Staging
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USERNAME }}
          key: ${{ secrets.DO_SSH_KEY }}
          source: "."
          target: "/tmp/stathis-staging-deploy/"
          rm: true

      - name: Deploy Staging
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USERNAME }}
          key: ${{ secrets.DO_SSH_KEY }}
          script: |
            echo "📥 Updating staging code..."
            cd /root/stathis
            
            # Update staging frontend code
            if [ -d "/tmp/stathis-staging-deploy/web/stathis-web" ]; then
              echo "Updating staging frontend..."
              rm -rf ./staging_frontend/frontend/*
              mkdir -p ./staging_frontend/frontend
              cp -r /tmp/stathis-staging-deploy/web/stathis-web/* ./staging_frontend/frontend/
            fi
            
            # Update staging backend code  
            if [ -d "/tmp/stathis-staging-deploy/backend/stathis" ]; then
              echo "Updating staging backend..."
              rm -rf ./staging_backend/backend/*
              mkdir -p ./staging_backend/backend
              cp -r /tmp/stathis-staging-deploy/backend/stathis/* ./staging_backend/backend/
            fi
            
            # Restart staging containers to pick up new code
            echo "🔄 Restarting staging containers..."
            docker compose restart stathis-frontend-staging stathis-backend-staging
            
            # Clean up temp files
            rm -rf /tmp/stathis-staging-deploy
            
            # Wait for services
            echo "⏳ Waiting for staging services to start..."
            sleep 30
            
            # Health checks
            echo "🔍 Checking staging service health..."
            
            # Check staging frontend
            if docker exec stathis-frontend-staging curl -f http://localhost:3000 >/dev/null 2>&1; then
              echo "✅ Staging frontend is healthy"
            else
              echo "⚠️  Staging frontend health check failed"
              docker logs stathis-frontend-staging --tail 10
            fi
            
            # Check staging backend
            if docker exec stathis-backend-staging curl -f http://localhost:8080 >/dev/null 2>&1; then
              echo "✅ Staging backend is healthy"
            else
              echo "⚠️  Staging backend health check failed"
              docker logs stathis-backend-staging --tail 10
            fi
            
            # Show resource usage
            echo ""
            echo "📊 Server Resources:"
            docker stats --no-stream --format "table {{.Container}}\t{{.CPUPerc}}\t{{.MemUsage}}"
            echo ""
            echo "💾 Disk Usage:"
            df -h /
            
            # Clean up old images
            docker image prune -f
            
            echo ""
            echo "🧪 Staging deployment complete!"
            echo "Web: https://staging-stathis.ryne.dev"
            echo "API: https://staging-api-stathis.ryne.dev"